branches:
  except:
    - gh-pages

language: cpp

compiler:
  - clang
  - gcc

git:
  submodules: false

env:
  global:
    - NUPIC=$TRAVIS_BUILD_DIR
    - NTA=$HOME/nta/eng
    - PATH=$TRAVIS_BUILD_DIR/python/bin:$PATH
  matrix:
    - PY_VER_FULL=2.7.6 PY_VER_SHORT=2.7
    - PY_VER_FULL=2.6.9 PY_VER_SHORT=2.6

notifications:
  irc:
    channels:
      - "irc.freenode.net#nupic-hackers"
  webhooks: http://issues.numenta.org:8081/travis

before_install:
  # Due to recent changes to Travis-CI build environment, we need to download,
  # build, and install, python, setuptools, pip, and all of the nupic python
  # dependencies
  - sudo add-apt-repository ppa:fkrull/deadsnakes
  - sudo apt-get update
  - sudo apt-get install libbz2-dev zlib1g-dev libssl-dev libsasl2-dev libreadline-dev python$PY_VER_SHORT python$PY_VER_SHORT-dev
  - (wget https://www.python.org/ftp/python/$PY_VER_FULL/Python-$PY_VER_FULL.tgz && tar xzf Python-$PY_VER_FULL.tgz && cd Python-$PY_VER_FULL && ./configure --enable-shared --prefix=${TRAVIS_BUILD_DIR}/python && make && make altinstall)

install:
  # Prefix env with our own python installation
  - "export PATH=$TRAVIS_BUILD_DIR/python/bin:$PATH"
  - "export PYTHONPATH=$TRAVIS_BUILD_DIR/python/lib/python$PY_VER_SHORT/site-packages:$PYTHONPATH:$NTA/lib/python$PY_VER_SHORT/site-packages"
  - "export LD_LIBRARY_PATH=$TRAVIS_BUILD_DIR/python/lib:$LD_LIBRARY_PATH"
  - "ln -s $TRAVIS_BUILD_DIR/python/bin/python$PY_VER_SHORT $TRAVIS_BUILD_DIR/python/bin/python"
  # Workaround for multiprocessing.Queue SemLock error from run_opf_bechmarks_test.
  # See: https://github.com/travis-ci/travis-cookbooks/issues/155
  - "sudo rm -rf /dev/shm && sudo ln -s /run/shm /dev/shm"
  # Install setuptools + pip
  - wget https://raw.github.com/pypa/pip/master/contrib/get-pip.py -O - | python
  # - (wget https://pypi.python.org/packages/source/s/setuptools/setuptools-3.4.4.tar.gz && tar xzvf setuptools-3.4.4.tar.gz && cd setuptools-3.4.4 && python setup.py install --prefix=$TRAVIS_BUILD_DIR/python)
  # - easy_install --install-dir=$TRAVIS_BUILD_DIR/python/lib/python$PY_VER_SHORT/site-packages --script-dir=$TRAVIS_BUILD_DIR/python/bin pip
  # Install NuPIC python dependencies
  - easy_install --install-dir=$TRAVIS_BUILD_DIR/python/lib/python$PY_VER_SHORT/site-packages --script-dir=$TRAVIS_BUILD_DIR/python/bin virtualenv
  - virtualenv --python=$TRAVIS_BUILD_DIR/python/bin/python .
  - source bin/activate
  - pip install -q -r $NUPIC/external/common/requirements.txt --install-option="--prefix=$TRAVIS_BUILD_DIR/python"
  - "mkdir -p $TRAVIS_BUILD_DIR/build/scripts"
  - "cd $TRAVIS_BUILD_DIR/build/scripts"
  - "cmake --version"
  # Build NuPIC
  - "PYTHON=$TRAVIS_BUILD_DIR/python/bin/python cmake $NUPIC -DPYTHON_LIBRARY=$TRAVIS_BUILD_DIR/python/lib/libpython$PY_VER_SHORT.so -DPROJECT_BUILD_RELEASE_DIR:STRING=$NTA"
  - "make -j3"
  - "cd"

script:
  - "cd $TRAVIS_BUILD_DIR/build/scripts"
  # legacy binary tests
  - "make tests_pyhtm"
  # actual unit tests
  - "make tests_run_all"
  - "cd"

  # run all example files
    # examples/bindings
  - "python $NUPIC/examples/bindings/sparse_matrix_how_to.py"
##  - "python $NUPIC/examples/bindings/svm_how_to.py" # tkinter missing in Travis build machine
##  - "python $NUPIC/examples/bindings/temporal_pooler_how_to.py" # tkinter too
    # examples/opf (run atleast 1 from each category)
  - "python $NUPIC/examples/opf/bin/OpfRunExperiment.py $NUPIC/examples/opf/experiments/anomaly/spatial/2field_few_skewed/"
  - "python $NUPIC/examples/opf/bin/OpfRunExperiment.py $NUPIC/examples/opf/experiments/anomaly/temporal/saw_200/"
  - "python $NUPIC/examples/opf/bin/OpfRunExperiment.py $NUPIC/examples/opf/experiments/classification/category_TP_1/"
  - "python $NUPIC/examples/opf/bin/OpfRunExperiment.py $NUPIC/examples/opf/experiments/missing_record/simple_0/"
  - "python $NUPIC/examples/opf/bin/OpfRunExperiment.py $NUPIC/examples/opf/experiments/multistep/hotgym/"
  - "python $NUPIC/examples/opf/bin/OpfRunExperiment.py $NUPIC/examples/opf/experiments/opfrunexperiment_test/simpleOPF/hotgym_1hr_agg/"
             # opf/experiments/params - skip now
  - "python $NUPIC/examples/opf/bin/OpfRunExperiment.py $NUPIC/examples/opf/experiments/spatial_classification/category_1/"
    # examples/prediction
  - "python $NUPIC/examples/prediction/RunExperiment.py $NUPIC/examples/prediction/experiments/dutyCycle/problem/"
    # examples/tp
  - "python $NUPIC/examples/tp/hello_tp.py"
  - "python $NUPIC/examples/tp/tp_test.py"

